#!/usr/bin/env ruby

require 'nokogiri'
require 'tempfile'

puts "--- :buildkite: Downloading `rspec-*.xml`"

`mkdir -p tmp`
`buildkite-agent artifact download tmp/rspec-*.xml tmp`

class Failure < Struct.new(:name, :classname, :body, :job); end

rspec_files = Dir["tmp/rspec-*.xml"]
all_failures = []

rspec_files.each do |file|
  puts "--- :junit: Parsing #{file}"
  job = file[/rspec-(.*).xml$/, 1]
  xml = File.read(file)
  doc = Nokogiri::XML(xml)

  doc.search('//testcase').each do |testcase|
    name = testcase['name']
    classname = testcase['classname']
    failures = testcase.search("failure")

    if failures.any?
      failures.each do |failure|
        all_failures << Failure.new(name, classname, failure.text.chomp.strip, job)
      end
    end
  end
end

puts "--- ❓ Checking failures"

if all_failures.empty?
  puts "No failures, all good!"
  exit 0
else
  puts "There are #{all_failures.length} errors... (boo)"
end

puts "--- ✍️ Preparing annotation"

buffer = "There were #{all_failures.length} failures:\n\n"
all_failures.each do |failure|
  buffer << "<details>\n"
  buffer << "<summary><code>#{failure.name} in #{failure.classname}</code></summary>\n\n"
  buffer << "<code><pre>#{failure.body}</pre></code>\n\n"
  buffer << %{in <a href="##{failure.job}">Job ##{failure.job}</a>\n}
  buffer << "</details>"
  buffer << "\n\n\n"
end
puts buffer

file = Tempfile.new('foo')
file.write(buffer)
file.close

puts "--- :buildkite: Creating annotation"

`cat #{file.path} | buildkite-agent annotate --context junit --style error`
exit $?.exitstatus
